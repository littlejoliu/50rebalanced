<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>50% æ­£2 ç­–ç•¥æ±ºç­–æ¨¡æ“¬å™¨</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; display: flex; align-items: center; }
        .input-group label { width: 200px; font-weight: 600; margin-right: 15px; color: #555; }
        .input-group input, .input-group select { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        .macro-button { background-color: #007bff; color: white; padding: 10px; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px; font-size: 14px; transition: background-color 0.3s; }
        .macro-button:hover { background-color: #0056b3; }
        button.execute-button { background-color: #28a745; color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; margin-top: 10px;}
        button.execute-button:hover { background-color: #218838; }
        #results { margin-top: 30px; padding: 20px; border: 1px dashed #007bff; border-radius: 8px; background-color: #eaf3ff; }
        .result-item { margin-bottom: 10px; font-size: 1.1em; }
        .action-buy { color: #28a745; font-weight: bold; }
        .action-sell { color: #dc3545; font-weight: bold; }
        .action-hold { color: #ffc107; font-weight: bold; }
        .macro-status { font-style: italic; color: #007bff; }
    </style>

    <script>
    // --- ç­–ç•¥åƒæ•¸å®šç¾© ---
    const THRESHOLD_QUARTER = 0.10; // å­£åº¦æª¢æŸ¥é–€æª»: 10%
    const THRESHOLD_EMERGENCY = 0.15; // ç·Šæ€¥é–€æª»: 15%
    const VIX_GREED = 12; // VIX æ¥µåº¦è‡ªæ»¿é–¾å€¼
    const VIX_FEAR = 30; // VIX æ¥µåº¦ææ‡¼é–¾å€¼
    const DEFAULT_P = 0.50; // é è¨­ç›®æ¨™æ¯”ä¾‹ P = 50%

    /**
     * é»æ“ŠæŒ‰éˆ•å¾Œè‡ªå‹•é–‹å•Ÿç›¸é—œæ•¸æ“šæŸ¥è©¢ç¶²ç«™
     */
    function openMacroSite(type) {
        if (type === 'light') {
            // æœ€çµ‚ä¿®æ­£ï¼šä½¿ç”¨ Google æœå°‹æ™¯æ°£å°ç­–ä¿¡è™Ÿ
            window.open('https://index.ndc.gov.tw/n/zh_tw', '_blank'); 
        } else if (type === 'VIX') {
            // VIX æŒ‡æ•¸ (ä¾‹å¦‚ï¼šYahoo Finance çš„å³æ™‚å ±åƒ¹)
            window.open('https://finance.yahoo.com/quote/%5EVIX', '_blank');
        }
    }

    /**
     * æ¨¡çµ„ä¸€ï¼šå®è§€ç›®æ¨™æ¯”ä¾‹ä¿®æ­£ï¼ˆå¤–ç’°ç´€å¾‹ï¼‰
     */
    function getTargetP(lightStatus, VIX_Value) {
        // 1. æ¥µåº¦è²ªå©ªï¼šç´…ç‡ˆ AND VIX æ¥µåº¦è‡ªæ»¿ (VIX <= 12) -> P=40%
        if (lightStatus === 'ç´…ç‡ˆ' && VIX_Value <= VIX_GREED) {
            return { P: 0.40, status: 'å®è§€æ¥µåº¦è²ªå©ª (ç´…ç‡ˆ & VIXâ‰¤12) å•Ÿå‹•ç…è»Š' };
        }
        // 2. æ¥µåº¦ææ…Œï¼šè—ç‡ˆ AND VIX æ¥µåº¦ææ‡¼ (VIX >= 30) -> P=60%
        if (lightStatus === 'è—ç‡ˆ' && VIX_Value >= VIX_FEAR) {
            return { P: 0.60, status: 'å®è§€æ¥µåº¦ææ…Œ (è—ç‡ˆ & VIXâ‰¥30) å•Ÿå‹•åŠ é€Ÿ' };
        }
        // 3. é è¨­ä¸­æ€§
        return { P: DEFAULT_P, status: 'ä¸­æ€§å€é–“ (ç›®æ¨™æ¯”ä¾‹ P=50%)' };
    }

    /**
     * æ¨¡çµ„äºŒï¼šå…§ç’°äº¤æ˜“è¨ˆç®—èˆ‡åˆ¤è®€
     */
    function executeStrategy() {
        // ç²å–è¼¸å…¥æ•¸æ“š
        const totalFunds = parseFloat(document.getElementById('totalFunds').value);
        const actual631LValue = parseFloat(document.getElementById('actual631LValue').value);
        const lightStatus = document.getElementById('macroStatus').value;
        const VIX_Value = parseFloat(document.getElementById('VIXValue').value);
        const isQuarterEnd = document.getElementById('isQuarterEnd').value === 'true';

        // æª¢æŸ¥åŸºæœ¬æœ‰æ•ˆæ€§
        if (isNaN(totalFunds) || isNaN(actual631LValue) || totalFunds <= 0) {
            // ç”±æ–¼å¯èƒ½åœ¨æœ¬åœ°é–‹å•Ÿï¼Œé¿å…éå¤š alert å½±éŸ¿é«”é©—ï¼Œåªåœ¨å¿…è¦æ™‚æç¤º
            // alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¸½è³‡é‡‘å’Œ 00631L å¸‚å€¼ã€‚"); 
            return;
        }

        // --- æ­¥é©Ÿ 1: å®è§€åˆ¤è®€ (å¤–ç’°) ---
        const { P, status } = getTargetP(lightStatus, VIX_Value);
        const targetRatio = P;
        const actualRatio = actual631LValue / totalFunds;
        const actualRatioPercent = (actualRatio * 100).toFixed(2) + '%';
        const targetRatioPercent = (targetRatio * 100).toFixed(0) + '%';
        const deviation = actualRatio - targetRatio;
        const deviationPercentage = (Math.abs(deviation) / targetRatio * 100).toFixed(2) + '%';

        // è¨ˆç®—ç›®æ¨™å¸‚å€¼
        const target631LValue = totalFunds * targetRatio;
        
        let action = 'ç¶­æŒä¸è®Š';
        let thresholdStatus = 'æœªè§¸ç™¼';
        let tradeAmount = 0;
        
        // è¨ˆç®—é–€æª»å€¼ (åŸºæ–¼æ–°çš„ P)
        const upperEmergency = targetRatio * (1 + THRESHOLD_EMERGENCY); 
        const lowerEmergency = targetRatio * (1 - THRESHOLD_EMERGENCY); 
        const upperQuarter = targetRatio * (1 + THRESHOLD_QUARTER); 
        const lowerQuarter = targetRatio * (1 - THRESHOLD_QUARTER); 

        // --- æ­¥é©Ÿ 2: å…§ç’°äº¤æ˜“åˆ¤æ–· ---

        // A. ç·Šæ€¥é–€æª» (æœ€å„ªå…ˆï¼Œç„¡è«–å­£åº¦æˆ–å¦)
        if (actualRatio >= upperEmergency) {
            // ç·Šæ€¥è³£å‡º (> P * 1.15)
            action = 'ç·Šæ€¥è³£å‡º';
            thresholdStatus = `<span class="action-sell">è§¸ç™¼ç·Šæ€¥è³£å‡ºé–€æª» (${(upperEmergency*100).toFixed(2)}%)</span>`;
            tradeAmount = actual631LValue - target631LValue;
        } else if (actualRatio <= lowerEmergency) {
            // ç·Šæ€¥è²·å…¥ (< P * 0.85)
            action = 'ç·Šæ€¥è²·å…¥';
            thresholdStatus = `<span class="action-buy">è§¸ç™¼ç·Šæ€¥è²·å…¥é–€æª» (${(lowerEmergency*100).toFixed(2)}%)</span>`;
            tradeAmount = target631LValue - actual631LValue;
        } 
        // B. å­£åº¦é–€æª» (åªåœ¨å­£åº¦æª¢æŸ¥æ—¥è§¸ç™¼)
        else if (isQuarterEnd) {
            if (actualRatio >= upperQuarter) {
                // å­£åº¦è³£å‡º (> P * 1.10)
                action = 'å­£åº¦è³£å‡º';
                thresholdStatus = `è§¸ç™¼å­£åº¦è³£å‡ºé–€æª» (${(upperQuarter*100).toFixed(2)}%)`;
                tradeAmount = actual631LValue - target631LValue;
            } else if (actualRatio <= lowerQuarter) {
                // å­£åº¦è²·å…¥ (< P * 0.90)
                action = 'å­£åº¦è²·å…¥';
                thresholdStatus = `è§¸ç™¼å­£åº¦è²·å…¥é–€æª» (${(lowerQuarter*100).toFixed(2)}%)`;
                tradeAmount = target631LValue - actual631LValue;
            }
        }
        
        // --- æ­¥é©Ÿ 3: çµæœè¼¸å‡º ---
        let actionClass = 'action-hold';
        let tradeText = 'ç„¡éœ€äº¤æ˜“ã€‚';
        if (action.includes('è³£å‡º')) {
            actionClass = 'action-sell';
            tradeText = `è³£å‡º $00631L$ é‡‘é¡: <span class="action-sell">NT$ ${tradeAmount.toFixed(0).toLocaleString()}</span> å…ƒã€‚`;
        } else if (action.includes('è²·å…¥')) {
            actionClass = 'action-buy';
            tradeText = `è²·å…¥ $00631L$ é‡‘é¡: <span class="action-buy">NT$ ${tradeAmount.toFixed(0).toLocaleString()}</span> å…ƒã€‚`;
        } else {
            const lowerQ = (lowerQuarter * 100).toFixed(2);
            const upperQ = (upperQuarter * 100).toFixed(2);
            tradeText = `<span class="action-hold">ç¶­æŒä¸è®Š (å¯¦éš›æ¯”ä¾‹åœ¨ ${lowerQ}% ~ ${upperQ}% ä¹‹é–“)ã€‚</span>`;
        }


        // é¡¯ç¤ºçµæœ
        document.getElementById('currentPStatus').innerHTML = `${status} (P = ${(P*100).toFixed(0)}%)`;
        document.getElementById('actualRatio').innerText = actualRatioPercent;
        document.getElementById('targetRatio').innerText = targetRatioPercent;
        document.getElementById('deviationPercentage').innerText = (deviation >= 0 ? 'è¶…é¡ ' : 'è™§æ ') + deviationPercentage;
        document.getElementById('thresholdStatus').innerHTML = thresholdStatus;
        document.getElementById('actionCommand').innerHTML = `<span class="${actionClass}">${action}</span>`;
        document.getElementById('tradeAmount').innerHTML = tradeText;
    }

    // *** é—œéµä¿®æ­£ï¼šä½¿ç”¨ DOMContentLoaded ç¢ºä¿ HTML å…ƒç´ å®Œå…¨è¼‰å…¥å¾Œå†åˆå§‹åŒ– ***
    document.addEventListener('DOMContentLoaded', () => {
        executeStrategy(); // é é¢è¼‰å…¥å¾Œè‡ªå‹•åŸ·è¡Œä¸€æ¬¡
        // å¦‚æœæœªä¾†éœ€è¦ï¼Œå¯ä»¥åœ¨æ­¤è™•è¨­ç½®å…¶ä»–äº‹ä»¶ç›£è½
    });

    </script>
</head>
<body>

<div class="container">
    <h2>ğŸ“ˆ $50\%$ æ­£ $2$ ç­–ç•¥æ±ºç­–æ¨¡æ“¬å™¨</h2>
    <p>è«‹æ‰‹å‹•è¼¸å…¥ç•¶å‰æ•¸æ“šä»¥é€²è¡Œç­–ç•¥åˆ¤è®€ï¼š</p>

    <div class="input-group">
        <label for="totalFunds">ç¸½è³‡é‡‘é‡ (å…ƒ):</label>
        <input type="number" id="totalFunds" value="1000000" min="1" step="1000">
    </div>
    <div class="input-group">
        <label for="actual631LValue">00631L ç¾æœ‰å¸‚å€¼ (å…ƒ):</label>
        <input type="number" id="actual631LValue" value="520000" min="0" step="1000">
    </div>

    <div class="input-group">
        <label for="macroStatus">æ™¯æ°£ç‡ˆè™Ÿ:</label>
        <select id="macroStatus">
            <option value="è—ç‡ˆ">è—ç‡ˆ (ä½è¿·)</option>
            <option value="é»ƒè—ç‡ˆ">é»ƒè—ç‡ˆ (ä½è¿·è½‰å‘)</option>
            <option value="ç¶ ç‡ˆ" selected>ç¶ ç‡ˆ (ç©©å®š)</option>
            <option value="é»ƒç´…ç‡ˆ">é»ƒç´…ç‡ˆ (è½‰å‘éç†±)</option>
            <option value="ç´…ç‡ˆ">ç´…ç‡ˆ (éç†±)</option>
        </select>
        <button onclick="executeStrategy(); openMacroSite('light')" class="macro-button">æŸ¥è©¢ç‡ˆè™Ÿ</button>
    </div>
    <div class="input-group">
        <label for="VIXValue">VIX æŒ‡æ•¸:</label>
        <input type="number" id="VIXValue" value="15" min="5" step="0.1">
        <button onclick="executeStrategy(); openMacroSite('VIX')" class="macro-button">æŸ¥è©¢ VIX</button>
    </div>
    <div class="input-group">
        <label for="isQuarterEnd">æ˜¯å¦ç‚ºå­£åº¦æª¢æŸ¥æ—¥ (ä¾‹å¦‚ 3/31, 6/30, 9/30, 12/31)?</label>
        <select id="isQuarterEnd">
            <option value="false" selected>å¦</option>
            <option value="true">æ˜¯</option>
        </select>
    </div>

    <button onclick="executeStrategy()" class="execute-button">åŸ·è¡Œç­–ç•¥åˆ¤è®€</button>

    <div id="results">
        <div class="result-item"><strong>ç•¶å‰ç‹€æ…‹ï¼š</strong> <span id="currentPStatus" class="macro-status"></span></div>
        <div class="result-item"><strong>å¯¦éš›æ¯”ä¾‹ï¼š</strong> <span id="actualRatio"></span> (ç›®æ¨™ <span id="targetRatio"></span>)</div>
        <div class="result-item"><strong>æ¯”ä¾‹åé›¢ï¼š</strong> <span id="deviationPercentage"></span></div>
        <div class="result-item"><strong>è¡Œå‹•é–€æª»ï¼š</strong> <span id="thresholdStatus"></span></div>
        <div class="result-item"><strong>ğŸ‘‰ ç­–ç•¥æŒ‡ä»¤ï¼š</strong> <span id="actionCommand"></span></div>
        <div class="result-item"><strong>è¨ˆç®—äº¤æ˜“é‡‘é¡ï¼š</strong> <span id="tradeAmount"></span></div>
    </div>
</div>

</body>
</html>